name: Deploy Alpha Preview

# -----------------------------------------------------------------------
#  The Rat's Guide to Alpha Previews
# -----------------------------------------------------------------------
#  Every pull request deserves a chance to shine (or squeak).
#  This workflow deploys PRs to a dedicated 'alpha-builds' branch.
#
#        (\_/)
#       (o.o)
#       (> <)  <-- "Is it ready yet?"
#
# -----------------------------------------------------------------------

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  # -----------------------------------------------------------------------
  # Job: Deploy Alpha
  # Description: Builds and deploys the PR to the 'alpha-builds' branch.
  # Trigger: Runs when a PR is opened, synchronized (updated), or reopened.
  # -----------------------------------------------------------------------
  deploy-alpha:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the code from the Pull Request
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Setup the environment (Node.js and pnpm)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      # Step 3: Setup Rust & WASM (For the heavy lifting)
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # Step 4: Build the project using the shared build script
      # This generates the static site in the '_site' directory.
      - name: Build Site
        run: |
          chmod +x build-lab.sh
          ./build-lab.sh

      # Step 4: Upload the build artifact to GitHub
      # This serves as a backup and allows manual inspection if deployment fails.
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: alpha-build-pr-${{ github.event.number }}
          path: _site/

      # Step 5: Deploy to the 'alpha-builds' branch
      # This involves:
      # - Switching to the target branch (orphaned if necessary).
      # - Creating a specific folder for this PR (alpha/pr-<ID>).
      # - Committing the new build files.
      - name: Deploy to Alpha Branch
        id: deploy
        run: |
          # Configure Git user for the commit
          git config --global user.name "Rat Bot"
          git config --global user.email "rat@lab.local"

          # Stash the build safely outside the repo so it survives the branch switch
          mkdir -p /tmp/rat_build
          cp -r _site/* /tmp/rat_build/

          # Clean up local build artifacts to prevent checkout errors
          rm -rf rats-music-converter/target
          rm -rf rats-music-converter/pkg
          rm -f rats-music-converter/Cargo.lock

          # Fetch and checkout alpha-builds branch
          # If it doesn't exist, create an orphan branch (empty history)
          if git ls-remote --exit-code --heads origin alpha-builds; then
            echo "Branch alpha-builds exists. Fetching..."
            git fetch origin alpha-builds
            git checkout alpha-builds
          else
            echo "Branch alpha-builds does not exist. Creating orphan..."
            git checkout --orphan alpha-builds
            git rm -rf .
          fi

          # Prepare target directory for this specific PR
          TARGET_DIR="alpha/pr-${{ github.event.number }}"
          mkdir -p "$TARGET_DIR"

          # Clean existing PR files in that folder to ensure fresh deploy
          # (We remove contents but keep the directory to avoid errors)
          rm -rf "$TARGET_DIR"/*

          # Copy build files from stash to the target directory
          cp -r /tmp/rat_build/* "$TARGET_DIR"/

          # Add changes to git staging
          git add .

          # Commit and Push if there are changes
          if ! git diff-index --quiet HEAD; then
            echo "Committing changes..."
            git commit -m "feat(alpha): deploy preview for PR #${{ github.event.number }}"
            git push origin alpha-builds
          else
             echo "No changes to deploy."
          fi

          echo "ALPHA_SHA=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      # Step 6: Post a comment on the PR
      # Provides the user with a direct link to the deployed preview.
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.issue.number;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const branch = 'alpha-builds';
            // Using raw.githack.com for preview serving (dev/volatile cache based on branch)
            // This ensures links expire (404) when the PR is closed and cleanup runs.
            const url = `https://raw.githack.com/${owner}/${repo}/${branch}/alpha/pr-${prNumber}/index.html`;

            const ratArt = `
            \`\`\`
                 __             _
                /  \\           / \\
               / ..|\\         /.. \\
              (_\\  |_)       (_\\  |)
              /  \\@'          /  \\@'
             /     \\         /     \\
            _/  \\  \\        _/  \\   \\
            \`\`\`
            `;

            const body = `
            ### üêÄ The Rats Have Deployed an Alpha!

            ${ratArt}

            Your changes have been staged in the **Alpha Zone**.

            - **üëÄ Preview Link**: [Click here to view the Alpha](${url})
            - **üì¶ Artifact**: If the link doesn't work (e.g., private repo), download the artifact from the "Summary" tab.

            *Squeak squeak!*
            `;

            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: body
            });

  # -----------------------------------------------------------------------
  # Job: Cleanup Alpha
  # Description: Removes the deployment folder when the PR is closed.
  # Trigger: Runs when a PR is closed (merged or discarded).
  # -----------------------------------------------------------------------
  cleanup-alpha:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Step 1: Remove the specific PR folder from the alpha-builds branch
      - name: Remove PR Folder
        run: |
          git config --global user.name "Rat Bot"
          git config --global user.email "rat@lab.local"

          # Check if branch exists before trying to delete from it
          if git ls-remote --exit-code --heads origin alpha-builds; then
            git fetch origin alpha-builds
            git checkout alpha-builds

            TARGET_DIR="alpha/pr-${{ github.event.number }}"

            if [ -d "$TARGET_DIR" ]; then
              git rm -rf "$TARGET_DIR"
              git commit -m "chore(alpha): remove preview for PR #${{ github.event.number }}"
              git push origin alpha-builds
            else
              echo "Directory $TARGET_DIR already gone."
            fi
          else
            echo "Alpha branch does not exist. Nothing to clean."
          fi

      # Step 2: Post a sign-off comment on the PR
      - name: Comment on PR Closure
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.issue.number;
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            const ratArt = `
            \`\`\`
                 __             _
                /  \\           / \\
               |  oo|         |  oo|
               |  _ |         | _  |
               | | | |        | | | |
               | | | |        | | | |
               | | | |        | | | |
               |_| |_|        |_| |_|
              (Bye!)         (See ya!)
            \`\`\`
            `;

            const body = `
            ### üêÄ The Alpha Rats Have Left the Building

            ${ratArt}

            The preview for this PR has been removed from the **Alpha Zone**.

            *The rats have scurried off to find more cheese.*
            `;

            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: body
            });
